name: Build luci-app-kidcontrol

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget curl libelf-dev ccache ecj fastjar java-propose-classpath \
          libncursesw5-dev python3 python3-setuptools libdeflate-tools

    - name: Clone OpenWrt source
      run: |
        git clone --depth=1 -b openwrt-24.10 https://github.com/openwrt/openwrt.git openwrt

    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Add luci-app-kidcontrol
      run: |
        cd openwrt/package
        git clone https://github.com/openwrt/luci.git
        cp -r luci/applications/luci-app-kidcontrol ./luci-app-kidcontrol
        rm -rf luci

    - name: Configure OpenWrt
      run: |
        cd openwrt
        make defconfig

    - name: Download sources
      run: |
        cd openwrt
        make download -j8 V=s

    - name: Build luci-app-kidcontrol with deps
      run: |
        cd openwrt
        make package/luci-app-kidcontrol/compile -j$(nproc) V=s
        make package/luci/compile -j$(nproc) V=s
        make package/feeds/luci/luci-base/compile -j$(nproc) V=s
        make package/feeds/packages/lua/compile -j$(nproc) V=s

    - name: Collect ipk files
      run: |
        mkdir -p ipk-out
        find openwrt/bin/packages/ -type f -name "*.ipk" -exec cp {} ipk-out/ \;
        find openwrt/bin/targets/ -type f -name "*.ipk" -exec cp {} ipk-out/ \;

    - name: Upload ipk
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-kidcontrol-full
        path: ipk-out/*.ipk
