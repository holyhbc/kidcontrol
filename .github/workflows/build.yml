name: Build luci-app-kidcontrol

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 20

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Display project structure
      run: |
        echo "=== é¡¹ç›®ç»“æ„ ==="
        find . -name "*" -type f | grep -E "(Makefile|\.c$|init.d|usr/|etc/)" | head -20
        echo ""
        echo "=== rootç›®å½•å†…å®¹ ==="
        find luci-app-kidcontrol/root -type f 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°rootç›®å½•"

    - name: Create IPK package structure
      run: |
        # åˆ›å»ºIPKåŒ…ç»“æ„
        mkdir -p ipk-build/CONTROL
        
        # åˆ›å»ºcontrolæ–‡ä»¶
        echo "Package: luci-app-kidcontrol" > ipk-build/CONTROL/control
        echo "Version: 1.0" >> ipk-build/CONTROL/control
        echo "Depends: nftables" >> ipk-build/CONTROL/control
        echo "Architecture: all" >> ipk-build/CONTROL/control
        echo "Maintainer: HolyHBC" >> ipk-build/CONTROL/control
        echo "Section: luci" >> ipk-build/CONTROL/control
        echo "Priority: optional" >> ipk-build/CONTROL/control
        echo "Description: LuCI support for Kid Control" >> ipk-build/CONTROL/control

        # å¤åˆ¶rootç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -d "luci-app-kidcontrol/root" ]; then
          echo "âœ… å¤åˆ¶rootç›®å½•æ–‡ä»¶"
          cp -r luci-app-kidcontrol/root/* ipk-build/
        fi

        # å¤åˆ¶æºä»£ç ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "luci-app-kidcontrol/src/kidcontrol.c" ]; then
          mkdir -p ipk-build/usr/src
          cp "luci-app-kidcontrol/src/kidcontrol.c" ipk-build/usr/src/
          echo "âœ… å¤åˆ¶æºä»£ç "
        fi

        # æ˜¾ç¤ºæœ€ç»ˆçš„æ–‡ä»¶ç»“æ„
        echo "=== IPKåŒ…æ–‡ä»¶ç»“æ„ ==="
        find ipk-build -type f

    - name: Create IPK package
      run: |
        # è¿›å…¥æ„å»ºç›®å½•
        cd ipk-build
        
        # åˆ›å»ºcontrol.tar.gz
        tar -czf ../control.tar.gz ./CONTROL/
        
        # åˆ›å»ºdata.tar.gzï¼ˆæ’é™¤CONTROLç›®å½•ï¼‰
        find . -path ./CONTROL -prune -o -type f -print | tar -czf ../data.tar.gz -T -
        
        # åˆ›å»ºdebian-binary
        echo "2.0" > ../debian-binary
        
        # å›åˆ°ä¸Šçº§ç›®å½•åˆ›å»ºIPK
        cd ..
        ar r luci-app-kidcontrol.ipk debian-binary control.tar.gz data.tar.gz
        
        # åˆ›å»ºè¾“å‡ºç›®å½•å¹¶å¤åˆ¶IPK
        mkdir -p output
        cp luci-app-kidcontrol.ipk output/
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f control.tar.gz data.tar.gz debian-binary
        rm -rf ipk-build
        
        echo "âœ… IPKåŒ…åˆ›å»ºæˆåŠŸ!"
        ls -la output/

    - name: Upload IPK artifact
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-kidcontrol-ipk
        path: output/luci-app-kidcontrol.ipk

    - name: Show success message
      run: |
        echo "=========================================="
        echo "ğŸ‰ æ„å»ºæˆåŠŸ!"
        echo "ğŸ“¦ åŒ…å: luci-app-kidcontrol"
        echo "ğŸ“ IPKæ–‡ä»¶å¯åœ¨Artifactsä¸­ä¸‹è½½"
        echo "=========================================="

    - name: Create backup package (if main method fails)
      if: failure()
      run: |
        # å¤‡ç”¨æ–¹æ¡ˆï¼šåˆ›å»ºåŒ…å«æ‰€æœ‰æ–‡ä»¶çš„zipåŒ…
        mkdir -p output
        zip -r output/kidcontrol-source.zip .
        echo "âœ… åˆ›å»ºæºä»£ç å¤‡ä»½åŒ…"
