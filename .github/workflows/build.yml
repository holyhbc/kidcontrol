name: Build luci-app-kidcontrol (via Docker SDK)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build with Docker SDK
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Build inside OpenWrt SDK Container
      run: |
        docker pull ghcr.io/openwrt/sdk:mediatek-filogic-24.10-SNAPSHOT
        docker run --rm -v "${{ github.workspace }}:/src" \
          -w /home/build/openwrt \
          ghcr.io/openwrt/sdk:mediatek-filogic-24.10-SNAPSHOT \
          /bin/sh -c "
            # 确保 package 目录存在
            mkdir -p /home/build/openwrt/package/luci-app-kidcontrol &&
            # 拷贝 luci-app-kidcontrol 到 SDK
            cp -r /src/luci-app-kidcontrol/* /home/build/openwrt/package/luci-app-kidcontrol/ &&
            # 更新 feeds
            ./scripts/feeds update -a &&
            ./scripts/feeds install -a &&
            # 默认配置
            make defconfig &&
            # 避免 ncurses menuconfig 报错
            export TERM=dumb &&
            # 编译 luci-app-kidcontrol
            make package/luci-app-kidcontrol/compile -j\$(nproc) V=s
          "

    - name: Generate version tag
      id: tag
      run: |
        VERSION="v24.10-${{ github.run_number }}-$(date +'%Y.%m.%d.%H%M')"
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: ${{ env.VERSION }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload IPK to Release
      uses: softprops/action-gh-release@v1
      with:
        files: /home/build/openwrt/bin/packages/*/base/luci-app-kidcontrol_*.ipk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
