name: Build luci-app-kidcontrol

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y wget tar build-essential

    - name: Download and extract SDK
      run: |
        # 下载 SDK
        wget https://downloads.openwrt.org/releases/23.05.3/targets/mediatek/filogic/openwrt-sdk-23.05.3-mediatek-filogic_gcc-12.3.0_musl.Linux-x86_64.tar.xz
        
        # 解压到当前目录
        tar -xf *.tar.xz
        
        # 查看解压后的目录
        echo "Extracted directories:"
        ls -la
        
        # 进入第一个找到的 openwrt-sdk 目录
        cd openwrt-sdk-*
        echo "Current directory: $(pwd)"
        
        # 复制包文件
        mkdir -p package/luci-app-kidcontrol
        cp -r ../* package/luci-app-kidcontrol/
        
        # 编译
        make package/luci-app-kidcontrol/compile
        
        # 复制生成的 IPK
        cp $(find bin -name "*.ipk") ../
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: kidcontrol-package
        path: *.ipk
