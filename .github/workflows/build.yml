name: Build luci-app-kidcontrol

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PACKAGE_NAME: luci-app-kidcontrol
  OPENWRT_VERSION: "24.10.1"
  TARGET: "mediatek/filogic"
  SUBTARGET: "mt7981"

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 120

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        path: source-code

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          curl \
          subversion

    - name: Clone OpenWrt source
      run: |
        git clone https://github.com/openwrt/openwrt.git openwrt-source
        cd openwrt-source
        git checkout v${{ env.OPENWRT_VERSION }}

    - name: Copy package files
      run: |
        cd $GITHUB_WORKSPACE
        # Êü•ÊâæÂπ∂Â§çÂà∂ÂåÖÊñá‰ª∂
        if [ -d "source-code" ]; then
          mkdir -p openwrt-source/package/network/services/${{ env.PACKAGE_NAME }}
          cp -r source-code/* openwrt-source/package/network/services/${{ env.PACKAGE_NAME }}/
          echo "‚úÖ Files copied from source-code/"
        else
          # Â§áÁî®ÊñπÊ°àÔºöÁõ¥Êé•‰ΩøÁî®ÂΩìÂâçÁõÆÂΩï
          mkdir -p openwrt-source/package/network/services/${{ env.PACKAGE_NAME }}
          cp -r * openwrt-source/package/network/services/${{ env.PACKAGE_NAME }}/
          echo "‚úÖ Files copied from workspace root"
        fi
        
        echo "Package contents:"
        ls -la openwrt-source/package/network/services/${{ env.PACKAGE_NAME }}/

    - name: Setup minimal configuration
      run: |
        cd $GITHUB_WORKSPACE/openwrt-source
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # ÊúÄÂ∞èÂåñÈÖçÁΩÆÔºåÈÅøÂÖçÁºñËØë‰∏çÂøÖË¶ÅÁöÑÂåÖ
        cat > .config << 'EOL'
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_filogic=y
CONFIG_TARGET_mediatek_filogic_mt7981=y
CONFIG_TARGET_mediatek_filogic_mt7981_360t7=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_nftables=y
CONFIG_PACKAGE_luci-app-kidcontrol=m
CONFIG_ALL_NONSHARED=n
CONFIG_ALL_KMODS=n
CONFIG_ALL=n
CONFIG_AUTOREMOVE=y
EOL
        
        make defconfig

    - name: Download only required sources
      run: |
        cd $GITHUB_WORKSPACE/openwrt-source
        # Âè™‰∏ãËΩΩÂøÖË¶ÅÁöÑÂåÖÔºåÈÅøÂÖçÁºñËØëÊï¥‰∏™Á≥ªÁªü
        make toolchain/install -j$(nproc)
        make package/nftables/download
        make package/luci/download
        make package/network/services/${{ env.PACKAGE_NAME }}/download

    - name: Build with simplified approach
      run: |
        cd $GITHUB_WORKSPACE/openwrt-source
        echo "Building with simplified approach..."
        
        # ÊñπÊ≥ï1ÔºöÂ∞ùËØïÁõ¥Êé•ÁºñËØëÊàë‰ª¨ÁöÑÂåÖÔºàËÆ©makeËá™Âä®Â§ÑÁêÜ‰æùËµñÔºâ
        make package/network/services/${{ env.PACKAGE_NAME }}/compile V=s -j1 || \
        # ÊñπÊ≥ï2ÔºöÂ¶ÇÊûúÂ§±Ë¥•ÔºåÂ∞ùËØïÂÖàÁºñËØë‰æùËµñ
        (echo "Direct compile failed, trying dependency-first approach..." && \
         make package/nftables/compile -j1 V=s && \
         make package/luci/compile -j1 V=s && \
         make package/network/services/${{ env.PACKAGE_NAME }}/compile V=s -j1)

    - name: Alternative build method
      if: failure()
      run: |
        cd $GITHUB_WORKSPACE/openwrt-source
        echo "Trying alternative build method..."
        
        # Ê∏ÖÈô§‰πãÂâçÁöÑÁºñËØëÁªìÊûú
        rm -rf build_dir/target-*/linux-mediatek_filogic/package/network/services/${{ env.PACKAGE_NAME }}
        
        # ‰ΩøÁî®Êõ¥ËØ¶ÁªÜÁöÑËæìÂá∫ÂíåÂçïÁ∫øÁ®ãÁºñËØë
        make package/network/services/${{ env.PACKAGE_NAME }}/clean
        make package/network/services/${{ env.PACKAGE_NAME }}/compile V=sc -j1

    - name: Find compiled package
      run: |
        cd $GITHUB_WORKSPACE/openwrt-source
        echo "Searching for IPK files..."
        
        # Âú®Â§ö‰∏™ÂèØËÉΩÁöÑ‰ΩçÁΩÆÊü•Êâæ
        IPK_PATHS=(
          "bin/packages/*/${{ env.PACKAGE_NAME }}*.ipk"
          "bin/targets/*/packages/${{ env.PACKAGE_NAME }}*.ipk"
          "bin/*/packages/*/${{ env.PACKAGE_NAME }}*.ipk"
        )
        
        for pattern in "${IPK_PATHS[@]}"; do
          IPK_FILE=$(find . -path "$pattern" 2>/dev/null | head -n 1)
          if [ -n "$IPK_FILE" ] && [ -f "$IPK_FILE" ]; then
            echo "‚úÖ Found: $IPK_FILE"
            mkdir -p $GITHUB_WORKSPACE/output
            cp "$IPK_FILE" $GITHUB_WORKSPACE/output/
            break
          fi
        done
        
        if [ ! -f "$GITHUB_WORKSPACE/output/"*.ipk ]; then
          echo "‚ùå No IPK file found"
          echo "Searching all IPK files:"
          find . -name "*.ipk" | head -20
          exit 1
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}-ipk
        path: output/*.ipk

    - name: Show build result
      run: |
        if [ -f "$GITHUB_WORKSPACE/output/"*.ipk ]; then
          echo "=========================================="
          echo "‚úÖ Build successful!"
          echo "üì¶ Package: ${{ env.PACKAGE_NAME }}"
          echo "üéØ For: 360T7 (MT7981)"
          echo "üìÅ IPK file available in artifacts"
          echo "=========================================="
        else
          echo "‚ùå Build failed"
          exit 1
        fi
