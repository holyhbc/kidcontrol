name: Build luci-app-kidcontrol

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PACKAGE_NAME: luci-app-kidcontrol

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Create IPK package
      run: |
        # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
        mkdir -p ipk-build/CONTROL
        mkdir -p ipk-build/usr/lib/lua/luci
        
        # åˆ›å»ºcontrolæ–‡ä»¶ - æœ€ç®€å•çš„æ–¹å¼
        echo "Package: ${{ env.PACKAGE_NAME }}" > ipk-build/CONTROL/control
        echo "Version: 1.0" >> ipk-build/CONTROL/control
        echo "Architecture: all" >> ipk-build/CONTROL/control  
        echo "Description: LuCI support for Kid Control" >> ipk-build/CONTROL/control
        
        # å¤åˆ¶æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -d "luasrc" ]; then
          cp -r luasrc/* ipk-build/usr/lib/lua/luci/
        fi
        
        if [ -d "src" ]; then
          cp -r src/* ipk-build/usr/lib/lua/luci/
        fi
        
        if [ -d "root" ]; then
          cp -r root/* ipk-build/
        fi
        
        # åˆ›å»ºtaråŒ…ï¼ˆä¿®æ­£tarå‘½ä»¤è¯­æ³•ï¼‰
        cd ipk-build
        tar -czf ../control.tar.gz CONTROL/
        find . -path ./CONTROL -prune -o -print | tar -czf ../data.tar.gz -T -
        
        # åˆ›å»ºdebian-binary
        echo "2.0" > ../debian-binary
        
        # åˆ›å»ºIPK
        cd ..
        ar r ${PACKAGE_NAME}.ipk debian-binary control.tar.gz data.tar.gz
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p output
        cp ${PACKAGE_NAME}.ipk output/
        
        echo "âœ… IPK created successfully!"
        ls -la output/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}-ipk
        path: output/*.ipk

    - name: Success message
      run: |
        echo "=========================================="
        echo "ğŸ‰ SUCCESS! IPK package created."
        echo "ğŸ“¦ File: ${{ env.PACKAGE_NAME }}.ipk"
        echo "ğŸ“ Download from Artifacts section"
        echo "=========================================="
