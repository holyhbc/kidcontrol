name: Build luci-app-kidcontrol for 360T7

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build OpenWrt IPK
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git wget tar xz-utils

    - name: Pull OpenWrt SDK Docker
      run: |
        docker pull ghcr.io/openwrt/sdk:mediatek-filogic-24.10-SNAPSHOT

    - name: Build luci-app-kidcontrol inside SDK
      run: |
        docker run --rm \
          -v "${{ github.workspace }}/luci-app-kidcontrol:/src/luci-app-kidcontrol" \
          -w /work \
          ghcr.io/openwrt/sdk:mediatek-filogic-24.10-SNAPSHOT \
          /bin/sh -c "
            set -e
            # 复制 OpenWrt 完整源码到容器内部可写目录
            git clone --depth=1 -b openwrt-24.10 https://git.openwrt.org/openwrt/openwrt.git /work/openwrt
            # 拷贝你的 package
            cp -r /src/luci-app-kidcontrol /work/openwrt/package/luci-app-kidcontrol
            export TERM=dumb
            cd /work/openwrt
            # 直接编译单包，不用 feeds
            make package/luci-app-kidcontrol/compile -j\$(nproc) V=s
          "

    - name: Generate version tag
      id: tag
      run: |
        VERSION="v24.10-${{ github.run_number }}-$(date +'%Y.%m.%d.%H%M')"
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: ${{ env.VERSION }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload IPK to Release
      uses: softprops/action-gh-release@v1
      with:
        files: /work/openwrt/bin/packages/*/base/luci-app-kidcontrol_*.ipk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload IPK as Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-kidcontrol-ipk
        path: /work/openwrt/bin/packages/*/base/luci-app-kidcontrol_*.ipk
