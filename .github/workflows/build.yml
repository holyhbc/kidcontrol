name: Build luci-app-kidcontrol

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Display project structure
      run: |
        echo "=== é¡¹ç›®ç»“æ„ ==="
        echo "å½“å‰ç›®å½•: $(pwd)"
        ls -la
        echo ""
        echo "luci-app-kidcontrolç›®å½•:"
        ls -la luci-app-kidcontrol/ || echo "ç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "é‡è¦æ–‡ä»¶æ£€æŸ¥:"
        [ -d "luci-app-kidcontrol/luasrc" ] && echo "âœ… luasrcç›®å½•å­˜åœ¨" || echo "âŒ luasrcç›®å½•ä¸å­˜åœ¨"
        [ -f "luci-app-kidcontrol/Makefile" ] && echo "âœ… Makefileå­˜åœ¨" || echo "âŒ Makefileä¸å­˜åœ¨"

    - name: Create IPK package structure
      run: |
        # åˆ›å»ºIPKåŒ…ç»“æ„
        mkdir -p ipk-build/CONTROL
        
        # åˆ›å»ºcontrolæ–‡ä»¶
        echo "Package: luci-app-kidcontrol" > ipk-build/CONTROL/control
        echo "Version: 1.0" >> ipk-build/CONTROL/control
        echo "Depends: nftables" >> ipk-build/CONTROL/control
        echo "Architecture: all" >> ipk-build/CONTROL/control
        echo "Maintainer: HolyHBC" >> ipk-build/CONTROL/control
        echo "Section: luci" >> ipk-build/CONTROL/control
        echo "Priority: optional" >> ipk-build/CONTROL/control
        echo "Description: LuCI support for Kid Control" >> ipk-build/CONTROL/control

        # å¤åˆ¶luasrcç›®å½•ï¼ˆæœ€é‡è¦çš„éƒ¨åˆ†ï¼‰
        if [ -d "luci-app-kidcontrol/luasrc" ]; then
          mkdir -p ipk-build/usr/lib/lua/luci
          cp -r luci-app-kidcontrol/luasrc/* ipk-build/usr/lib/lua/luci/
          echo "âœ… å¤åˆ¶luasrcç›®å½•"
        else
          echo "âŒ é”™è¯¯: luasrcç›®å½•ä¸å­˜åœ¨ï¼"
          exit 1
        fi

        # å¤åˆ¶rootç›®å½•ï¼ˆå¦‚æœæœ‰ï¼‰
        if [ -d "luci-app-kidcontrol/root" ]; then
          cp -r luci-app-kidcontrol/root/* ipk-build/
          echo "âœ… å¤åˆ¶rootç›®å½•"
        fi

        echo "æœ€ç»ˆæ–‡ä»¶ç»“æ„:"
        find ipk-build -type f | head -10

    - name: Create IPK package
      run: |
        # åˆ›å»ºtaråŒ…
        cd ipk-build
        tar -czf ../control.tar.gz CONTROL/
        find . -path ./CONTROL -prune -o -type f -print | tar -czf ../data.tar.gz -T -
        echo "2.0" > ../debian-binary
        
        # åˆ›å»ºIPK
        cd ..
        ar r luci-app-kidcontrol.ipk debian-binary control.tar.gz data.tar.gz
        
        # å‡†å¤‡è¾“å‡º
        mkdir -p output
        cp luci-app-kidcontrol.ipk output/
        
        # æ¸…ç†
        rm -f control.tar.gz data.tar.gz debian-binary
        rm -rf ipk-build
        
        echo "âœ… IPKåˆ›å»ºæˆåŠŸ!"
        ls -la output/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-kidcontrol-ipk
        path: output/luci-app-kidcontrol.ipk

    - name: Success message
      run: |
        echo "=========================================="
        echo "ğŸ‰ ç¼–è¯‘æˆåŠŸ!"
        echo "ğŸ“¦ çº¯Luaåº”ç”¨ä¸éœ€è¦srcç›®å½•"
        echo "ğŸ“ IPKæ–‡ä»¶å·²ç”Ÿæˆ"
        echo "=========================================="
